<!DOCTYPE html>
<Dhtml lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Divine Guest House – Staff Portal</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ─── Reset & Root ─── */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --ink:#1a1a1a;--ink2:#444;--ink3:#777;--ink4:#aaa;
  --bg:#f5f4f2;--card:#fff;--card-hover:#fafaf8;
  --border:#e4e2de;--border-dark:#ccc;
  --green:#16a34a;--green-bg:#f0fdf4;--green-border:#bbf7d0;
  --red:#dc2626;--red-bg:#fef2f2;--red-border:#fecaca;
  --amber:#d97706;--amber-bg:#fffbeb;--amber-border:#fde68a;
  --blue:#2563eb;--blue-bg:#eff6ff;--blue-border:#bfdbfe;
  --shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --shadow-md:0 4px 12px rgba(0,0,0,.08);
  --shadow-lg:0 12px 32px rgba(0,0,0,.12);
  --radius:10px;--radius-sm:7px;--radius-lg:14px;
  font-family:'DM Sans',system-ui,sans-serif;
}

body{background:var(--bg);color:var(--ink);font-size:14px;line-height:1.5;min-height:100vh}

/* ─── Scrollbar ─── */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border-dark);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#999}

/* ─── Icons helper ─── */
.icon{display:inline-flex;align-items:center;justify-content:center;flex-shrink:0}
.icon svg{display:block}

/* ═══════════════════ LOGIN ═══════════════════ */
.login-screen{position:fixed;inset:0;background:var(--card);display:flex;align-items:center;justify-content:center;z-index:500;transition:opacity .3s}
.login-screen.hidden{display:none}
.login-box{width:100%;max-width:380px;padding:0 32px}
.login-logo{display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:8px}
.login-logo-mark{width:44px;height:44px;background:var(--ink);border-radius:10px;display:flex;align-items:center;justify-content:center}
.login-title{font-size:22px;font-weight:700;letter-spacing:.5px;color:var(--ink)}
.login-sub{font-size:12px;color:var(--ink3);text-align:center;margin-bottom:36px;letter-spacing:.3px;text-transform:uppercase}
.login-field{position:relative;margin-bottom:14px}
.login-field .field-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--ink4)}
.login-field input{width:100%;padding:14px 16px 14px 42px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:15px;font-family:inherit;background:var(--bg);transition:border-color .2s,box-shadow .2s}
.login-field input:focus{outline:none;border-color:var(--ink);box-shadow:0 0 0 3px rgba(26,26,26,.08)}
.login-field input::placeholder{color:var(--ink4)}
.btn-login{width:100%;padding:14px;background:var(--ink);color:#fff;border:none;border-radius:var(--radius);font-size:15px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:8px;transition:background .2s,transform .1s}
.btn-login:hover{background:#000}
.btn-login:active{transform:scale(.98)}
.login-error{color:var(--red);font-size:13px;margin-top:14px;text-align:center;display:none;min-height:18px}
.login-error.show{display:block}

/* ═══════════════════ APP LAYOUT ═══════════════════ */
#app{display:none;min-height:100vh;flex-direction:column}
#app.visible{display:flex}

/* ─── Header ─── */
.header{background:var(--card);border-bottom:1px solid var(--border);padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;box-shadow:var(--shadow)}
.header-left{display:flex;align-items:center;gap:12px}
.header-logo-mark{width:34px;height:34px;background:var(--ink);border-radius:8px;display:flex;align-items:center;justify-content:center}
.header-brand{font-size:16px;font-weight:700;letter-spacing:.8px;color:var(--ink)}
.header-brand span{font-weight:400;color:var(--ink3)}
.header-right{display:flex;align-items:center;gap:10px}

/* ─── Header Buttons ─── */
.hdr-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:var(--radius-sm);border:1.5px solid var(--border);background:var(--card);color:var(--ink);font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;transition:all .15s;text-decoration:none}
.hdr-btn:hover{border-color:var(--ink);background:var(--card-hover)}
.hdr-btn.primary{background:var(--ink);color:#fff;border-color:var(--ink)}
.hdr-btn.primary:hover{background:#000}

/* ─── Notification Bell ─── */
.notif-bell{position:relative;width:40px;height:40px;border-radius:var(--radius-sm);border:1.5px solid var(--border);background:var(--card);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s}
.notif-bell:hover{border-color:var(--ink);background:var(--card-hover)}
.notif-badge{position:absolute;top:5px;right:5px;min-width:17px;height:17px;background:var(--red);color:#fff;border-radius:9px;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;border:2px solid var(--card);animation:pulse 2s infinite}
.notif-badge.hidden{display:none}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}

/* ═══════════════════ MAIN CONTENT ═══════════════════ */
.main{flex:1;padding:28px 28px 40px;max-width:1280px;margin:0 auto;width:100%}

/* ─── Stats Row ─── */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:28px}
.stat-card{background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:18px 20px;box-shadow:var(--shadow);transition:border-color .2s}
.stat-card:hover{border-color:var(--border-dark)}
.stat-top{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.stat-icon-wrap{width:36px;height:36px;border-radius:9px;background:var(--bg);display:flex;align-items:center;justify-content:center;color:var(--ink2)}
.stat-label{font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.7px}
.stat-val{font-size:24px;font-weight:700;color:var(--ink);line-height:1.1}
.stat-sub{font-size:11px;color:var(--ink4);margin-top:3px}

/* ─── Quick Actions ─── */
.quick-row{display:flex;gap:10px;margin-bottom:24px;flex-wrap:wrap}
.quick-btn{display:inline-flex;align-items:center;gap:7px;padding:9px 16px;background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:13px;font-weight:500;color:var(--ink);cursor:pointer;font-family:inherit;transition:all .15s;box-shadow:var(--shadow)}
.quick-btn:hover{border-color:var(--ink);background:var(--card-hover)}
.quick-btn.active{background:var(--ink);color:#fff;border-color:var(--ink)}

/* ─── Section ─── */
.section{margin-bottom:28px}
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px}
.section-title{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;color:var(--ink2);text-transform:uppercase;letter-spacing:.7px}

/* ─── Date Scroll ─── */
.date-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px}
.date-btn{flex-shrink:0;min-width:72px;background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius);padding:10px 8px;text-align:center;cursor:pointer;transition:all .15s;box-shadow:var(--shadow)}
.date-btn:hover{border-color:var(--border-dark)}
.date-btn.active{background:var(--ink);border-color:var(--ink);color:#fff;box-shadow:var(--shadow-md)}
.date-day{font-size:10px;text-transform:uppercase;letter-spacing:.8px;opacity:.55;margin-bottom:3px;font-weight:600}
.date-num{font-size:18px;font-weight:700}

/* ─── Filter Tabs ─── */
.filter-tabs{display:flex;gap:4px;background:var(--bg);padding:3px;border-radius:var(--radius-sm);border:1px solid var(--border)}
.filter-tab{display:flex;align-items:center;gap:5px;padding:7px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;color:var(--ink3);transition:all .15s}
.filter-tab:hover{color:var(--ink)}
.filter-tab.active{background:var(--card);color:var(--ink);box-shadow:var(--shadow)}

/* ─── Room Grid ─── */
.room-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px}
.room-card{background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:20px 16px;text-align:center;transition:all .2s;box-shadow:var(--shadow)}
.room-card.available{border-color:var(--green-border);background:var(--green-bg)}
.room-card.busy{border-color:var(--red-border);background:var(--red-bg);opacity:.65}
.room-card .room-icon-wrap{width:44px;height:44px;border-radius:10px;margin:0 auto 12px;display:flex;align-items:center;justify-content:center}
.room-card.available .room-icon-wrap{background:rgba(22,163,74,.12);color:var(--green)}
.room-card.busy .room-icon-wrap{background:rgba(220,38,38,.12);color:var(--red)}
.room-card .room-name{font-size:15px;font-weight:600;margin-bottom:4px}
.room-card .room-status{font-size:13px;font-weight:600}
.room-card.available .room-status{color:var(--green)}
.room-card.busy .room-status{color:var(--red)}
.room-card .room-cap{font-size:11px;color:var(--ink4);margin-top:2px}

/* ─── Search ─── */
.search-wrap{position:relative;width:280px;max-width:100%}
.search-wrap .s-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--ink4);pointer-events:none}
.search-wrap input{width:100%;padding:9px 14px 9px 38px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:13px;font-family:inherit;background:var(--card);transition:border-color .2s;box-shadow:var(--shadow)}
.search-wrap input:focus{outline:none;border-color:var(--ink)}
.search-wrap input::placeholder{color:var(--ink4)}

/* ─── Booking Cards ─── */
.bookings-list{display:flex;flex-direction:column;gap:10px}
.booking-card{background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:14px 16px;display:flex;align-items:center;gap:14px;transition:border-color .15s;box-shadow:var(--shadow)}
.booking-card:hover{border-color:var(--border-dark)}
.b-avatar{width:40px;height:40px;border-radius:50%;background:var(--bg);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--ink2)}
.b-info{flex:1;min-width:0}
.b-name{font-size:15px;font-weight:600;color:var(--ink);margin-bottom:5px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.b-meta{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
.b-meta-item{display:flex;align-items:center;gap:4px;font-size:12px;color:var(--ink3)}
.b-meta-sep{width:3px;height:3px;border-radius:50%;background:var(--border-dark)}
.b-actions{display:flex;gap:6px;flex-shrink:0}

/* Status Badges */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:11px;font-weight:600;letter-spacing:.2px}
.badge-pending{background:var(--amber-bg);color:var(--amber);border:1px solid var(--amber-border)}
.badge-checked-in{background:var(--green-bg);color:var(--green);border:1px solid var(--green-border)}
.badge-checked-out{background:var(--bg);color:var(--ink3);border:1px solid var(--border)}

/* Action Buttons */
.act-btn{display:inline-flex;align-items:center;gap:5px;padding:7px 12px;border-radius:var(--radius-sm);border:none;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s}
.act-btn:hover{opacity:.85;transform:translateY(-1px)}
.act-btn:active{transform:translateY(0)}
.act-btn.checkin{background:var(--green);color:#fff}
.act-btn.checkout{background:var(--ink);color:#fff}
.act-btn.edit{background:var(--bg);color:var(--ink);border:1.5px solid var(--border)}
.act-btn.edit:hover{border-color:var(--ink)}
.act-btn.del{background:var(--red-bg);color:var(--red);border:1.5px solid var(--red-border)}
.act-btn.del:hover{background:var(--red);color:#fff}

/* Empty State */
.empty-state{text-align:center;padding:56px 24px;color:var(--ink3)}
.empty-icon-wrap{width:56px;height:56px;border-radius:14px;background:var(--bg);margin:0 auto 14px;display:flex;align-items:center;justify-content:center;color:var(--ink4)}
.empty-state p{font-size:14px}

/* ═══════════════════ CHECK-IN MODAL ═══════════════════ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:300;padding:20px}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border-radius:18px;width:100%;max-width:540px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);animation:modalIn .22s cubic-bezier(.22,.61,.36,1)}
@keyframes modalIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

.modal-head{display:flex;align-items:center;justify-content:space-between;padding:22px 26px 0}
.modal-head-left{display:flex;align-items:center;gap:12px}
.modal-head-icon{width:40px;height:40px;border-radius:10px;background:var(--ink);color:#fff;display:flex;align-items:center;justify-content:center}
.modal-title{font-size:18px;font-weight:700;color:var(--ink)}
.modal-sub{font-size:12px;color:var(--ink3);margin-top:1px}
.modal-close{width:34px;height:34px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--ink3);transition:all .15s}
.modal-close:hover{border-color:var(--ink);color:var(--ink);background:var(--card)}

.modal-body{padding:22px 26px 26px}

/* ─── Check-in Search / Guest Selector ─── */
.checkin-search{position:relative;margin-bottom:6px}
.checkin-search .cs-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--ink4);pointer-events:none}
.checkin-search input{width:100%;padding:13px 16px 13px 44px;border:1.5px solid var(--border);border-radius:var(--radius);font-size:15px;font-family:inherit;background:var(--bg);transition:border-color .2s,box-shadow .2s}
.checkin-search input:focus{outline:none;border-color:var(--ink);box-shadow:0 0 0 3px rgba(26,26,26,.08);background:#fff}
.checkin-search input::placeholder{color:var(--ink4)}

/* Pending guests dropdown */
.pending-list{margin-top:8px;border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;background:var(--card);box-shadow:var(--shadow-md);max-height:220px;overflow-y:auto}
.pending-list.hidden{display:none}
.pending-item{display:flex;align-items:center;gap:12px;padding:11px 14px;cursor:pointer;transition:background .12s;border-bottom:1px solid var(--border)}
.pending-item:last-child{border-bottom:none}
.pending-item:hover{background:var(--bg)}
.pending-item.selected{background:var(--blue-bg);border-left:3px solid var(--blue)}
.pi-avatar{width:34px;height:34px;border-radius:50%;background:var(--bg);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--ink2)}
.pi-info{flex:1;min-width:0}
.pi-name{font-size:14px;font-weight:600;color:var(--ink)}
.pi-detail{font-size:12px;color:var(--ink3);margin-top:1px}
.pi-badge{flex-shrink:0}
.pending-empty{padding:28px;text-align:center;color:var(--ink4);font-size:13px}

/* ─── Guest Card (selected) ─── */
.guest-card{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:14px 16px;margin-top:10px;display:none}
.guest-card.show{display:block}
.gc-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.gc-avatar{width:42px;height:42px;border-radius:50%;background:var(--card);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--ink2)}
.gc-name{font-size:15px;font-weight:700;color:var(--ink)}
.gc-ref{font-size:12px;color:var(--ink3);font-family:'DM Mono',monospace;margin-top:1px}
.gc-details{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.gc-detail{display:flex;align-items:center;gap:7px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 10px}
.gc-detail .gcd-icon{color:var(--ink3);flex-shrink:0}
.gc-detail .gcd-val{font-size:13px;color:var(--ink);font-weight:500}
.gc-detail .gcd-label{font-size:10px;color:var(--ink4);display:block;margin-bottom:1px;text-transform:uppercase;letter-spacing:.4px}

/* ─── Document Upload ─── */
.doc-upload{margin-top:16px}
.doc-upload-label{font-size:12px;font-weight:600;color:var(--ink2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.drop-zone{border:1.5px dashed var(--border-dark);border-radius:var(--radius);padding:22px 16px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg);position:relative}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--blue);background:var(--blue-bg)}
.drop-zone input[type=file]{position:absolute;inset:0;opacity:0;width:100%;height:100%;cursor:pointer}
.dz-icon{margin:0 auto 8px;color:var(--ink3)}
.dz-text{font-size:13px;color:var(--ink2);font-weight:500}
.dz-sub{font-size:11px;color:var(--ink4);margin-top:2px}
/* Uploaded preview strip */
.doc-preview{display:flex;align-items:center;gap:10px;margin-top:8px;padding:8px 10px;background:var(--card);border:1px solid var(--green-border);border-radius:var(--radius-sm)}
.doc-preview .dp-icon{color:var(--green);flex-shrink:0}
.doc-preview .dp-name{font-size:13px;font-weight:500;color:var(--ink);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.doc-preview .dp-size{font-size:11px;color:var(--ink4)}
.doc-preview .dp-remove{cursor:pointer;color:var(--ink4);transition:color .15s}
.doc-preview .dp-remove:hover{color:var(--red)}

/* ─── Modal Footer ─── */
.modal-footer{display:flex;gap:10px;margin-top:22px}
.btn-confirm{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:13px;background:var(--green);color:#fff;border:none;border-radius:var(--radius);font-size:15px;font-weight:600;cursor:pointer;font-family:inherit;transition:background .2s,transform .1s;box-shadow:0 2px 6px rgba(22,163,74,.3)}
.btn-confirm:hover{background:#15803d}
.btn-confirm:active{transform:scale(.97)}
.btn-confirm:disabled{background:var(--border-dark);box-shadow:none;cursor:not-allowed}
.btn-cancel{padding:13px 22px;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius);font-size:14px;font-weight:600;color:var(--ink);cursor:pointer;font-family:inherit;transition:all .15s}
.btn-cancel:hover{border-color:var(--ink)}

/* ─── New Check-in Button (replaces link) ─── */
.new-checkin-link{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:14px;padding:10px;border:1.5px dashed var(--border);border-radius:var(--radius-sm);background:var(--bg);color:var(--ink2);font-size:13px;font-weight:500;cursor:pointer;text-decoration:none;transition:all .18s;width:100%;font-family:inherit}
.new-checkin-link:hover{border-color:var(--ink);background:var(--card);color:var(--ink)}

/* ─── Edit Modal ─── */
.edit-modal .modal-head-icon{background:var(--blue)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}
.form-group input,.form-group select{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:14px;font-family:inherit;background:var(--bg);color:var(--ink);transition:border-color .2s}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--ink);background:#fff}
.form-group select{cursor:pointer}
.btn-save{width:100%;display:flex;align-items:center;justify-content:center;gap:8px;padding:13px;background:var(--ink);color:#fff;border:none;border-radius:var(--radius);font-size:15px;font-weight:600;cursor:pointer;font-family:inherit;transition:background .2s}
.btn-save:hover{background:#000}

/* ─── Document Display in Edit Modal ─── */
.edit-doc-section{margin-top:16px;margin-bottom:16px}
.edit-doc-label{font-size:12px;font-weight:600;color:var(--ink2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.edit-doc-preview{border:1.5px solid var(--border);border-radius:var(--radius);padding:12px;background:var(--bg);display:none}
.edit-doc-preview.show{display:block}
.edit-doc-img{width:100%;max-height:200px;object-fit:contain;border-radius:var(--radius-sm);margin-bottom:10px;background:#fff}
.edit-doc-info{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm)}
.edit-doc-name{font-size:13px;font-weight:500;color:var(--ink);flex:1}
.edit-doc-actions{display:flex;gap:6px}
.edit-doc-btn{padding:5px 10px;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;display:inline-flex;align-items:center;gap:4px;border:none}
.edit-doc-btn.view{background:var(--blue-bg);color:var(--blue)}
.edit-doc-btn.change{background:var(--amber-bg);color:var(--amber)}
.edit-doc-btn:hover{opacity:.85}
.edit-doc-upload{border:1.5px dashed var(--border-dark);border-radius:var(--radius);padding:16px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg);position:relative;margin-top:8px}
.edit-doc-upload:hover{border-color:var(--blue);background:var(--blue-bg)}
.edit-doc-upload input[type=file]{position:absolute;inset:0;opacity:0;width:100%;height:100%;cursor:pointer}
.edit-doc-upload-text{font-size:12px;color:var(--ink2);font-weight:500}
.edit-doc-none{padding:12px;text-align:center;color:var(--ink4);font-size:12px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm)}

/* ─── Notification Panel ─── */
.notif-panel{position:fixed;right:20px;top:70px;width:380px;max-height:580px;background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);display:none;flex-direction:column;z-index:250;overflow:hidden}
.notif-panel.show{display:flex}
.np-head{padding:16px 18px 12px;border-bottom:1px solid var(--border)}
.np-title{font-size:14px;font-weight:700;color:var(--ink);margin-bottom:10px;display:flex;align-items:center;gap:7px}
.np-tabs{display:flex;gap:4px;background:var(--bg);padding:3px;border-radius:var(--radius-sm)}
.np-tab{flex:1;display:flex;align-items:center;justify-content:center;gap:5px;padding:7px 10px;border-radius:6px;font-size:12px;font-weight:600;color:var(--ink3);cursor:pointer;transition:all .15s}
.np-tab:hover{color:var(--ink)}
.np-tab.active{background:var(--card);color:var(--ink);box-shadow:var(--shadow)}
.np-tab-badge{background:var(--red);color:#fff;border-radius:9px;padding:1px 6px;font-size:10px;font-weight:700;min-width:16px;text-align:center}
.np-tab.active .np-tab-badge{background:var(--ink)}
.np-tab-badge.hidden{display:none}
.np-clear{font-size:11px;color:var(--blue);cursor:pointer;text-align:center;padding:8px 0 4px;transition:opacity .15s}
.np-clear:hover{opacity:.7}
.np-list{overflow-y:auto;max-height:440px}
.np-item{padding:13px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s;position:relative}
.np-item:last-child{border-bottom:none}
.np-item:hover{background:var(--bg)}
.np-item.unread{background:#f0f7ff}
.np-item.unread::before{content:'';position:absolute;left:7px;top:50%;transform:translateY(-50%);width:6px;height:6px;background:var(--green);border-radius:50%}
.np-guest{font-size:14px;font-weight:600;color:var(--ink);margin-bottom:4px;margin-left:8px}
.np-details{font-size:12px;color:var(--ink3);display:flex;flex-wrap:wrap;gap:6px;margin-left:8px}
.np-det-item{display:flex;align-items:center;gap:3px}
.np-time{font-size:11px;color:var(--ink4);margin-top:3px;margin-left:8px}
.np-btns{display:flex;gap:6px;margin-top:7px;margin-left:8px}
.np-btn{padding:5px 10px;border-radius:5px;font-size:11px;font-weight:600;border:none;cursor:pointer;font-family:inherit;transition:all .15s;display:inline-flex;align-items:center;gap:4px}
.np-btn:hover{opacity:.85}
.np-btn.done{background:var(--green);color:#fff}
.np-btn.view{background:var(--bg);color:var(--ink);border:1px solid var(--border)}
.np-empty{padding:50px 20px;text-align:center;color:var(--ink4)}
.np-empty-icon{width:44px;height:44px;margin:0 auto 10px;border-radius:12px;background:var(--bg);display:flex;align-items:center;justify-content:center;color:var(--ink4)}
.np-date-header{padding:8px 16px;background:var(--bg);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--ink3);border-bottom:1px solid var(--border)}

/* ─── Spinner ─── */
.spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .5s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner.dark{border-color:rgba(26,26,26,.2);border-top-color:var(--ink)}

/* ─── Toast ─── */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--ink);color:#fff;padding:12px 22px;border-radius:var(--radius);font-size:14px;font-weight:500;z-index:600;transition:transform .3s cubic-bezier(.22,.61,.36,1);display:flex;align-items:center;gap:10px;box-shadow:var(--shadow-md)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.success{background:var(--green)}
.toast.error{background:var(--red)}

/* ═══════════════════ IFRAME MODAL (New Check-in) ═══════════════════ */
.iframe-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:400;display:none;align-items:center;justify-content:center;padding:16px}
.iframe-overlay.show{display:flex}
.iframe-modal{background:var(--card);border-radius:18px;width:100%;max-width:600px;max-height:90vh;display:flex;flex-direction:column;box-shadow:var(--shadow-lg);animation:modalIn .22s cubic-bezier(.22,.61,.36,1);overflow:hidden}
.iframe-modal-head{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);flex-shrink:0}
.iframe-modal-head-left{display:flex;align-items:center;gap:10px}
.iframe-modal-icon{width:36px;height:36px;border-radius:9px;background:var(--green);color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.iframe-modal-title{font-size:16px;font-weight:700;color:var(--ink)}
.iframe-modal-sub{font-size:12px;color:var(--ink3);margin-top:1px}
.iframe-modal-close{width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--ink3);transition:all .15s;flex-shrink:0}
.iframe-modal-close:hover{border-color:var(--ink);color:var(--ink);background:var(--card)}
.iframe-modal iframe{flex:1;width:100%;border:none;min-height:400px;max-height:calc(90vh - 75px)}
.iframe-loading{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;padding:40px;min-height:300px}
.iframe-loading .spinner.dark{width:28px;height:28px;border-width:3px}
.iframe-loading p{font-size:13px;color:var(--ink3)}

/* ─── Responsive ─── */
@media(max-width:768px){
  .main{padding:20px 16px 40px}
  .stats-row{grid-template-columns:repeat(2,1fr)}
  .room-grid{grid-template-columns:repeat(2,1fr)}
  .booking-card{flex-direction:column;align-items:stretch}
  .b-actions{justify-content:flex-end;flex-wrap:wrap}
  .form-row{grid-template-columns:1fr}
  .notif-panel{right:10px;left:10px;width:auto;top:60px}
  .search-wrap{width:100%}
  .modal{max-height:95vh}
  .gc-details{grid-template-columns:1fr}
  .modal-head{padding:18px 18px 0}
  .modal-body{padding:18px 18px 22px}
  .header{padding:0 14px}
  .hdr-btn span,.hdr-btn .btn-label{display:none}
  .hdr-btn{padding:8px 10px;gap:0}
  .iframe-modal{max-height:95vh}
  .iframe-modal iframe{min-height:350px;max-height:calc(95vh - 70px)}
  .edit-doc-info{flex-direction:column;align-items:flex-start;gap:8px}
  .edit-doc-actions{width:100%}
  .edit-doc-btn{flex:1;justify-content:center}
}
@media(max-width:400px){
  .stats-row{grid-template-columns:1fr 1fr}
  .stat-card{padding:14px 12px}
  .stat-val{font-size:20px}
  .quick-row{gap:6px}
  .quick-btn{padding:8px 10px;font-size:12px}
  .b-actions{gap:4px}
  .act-btn{padding:6px 8px;font-size:11px}
  .act-btn span{display:none}
  .modal-head,.modal-body{padding-left:14px;padding-right:14px}
  .iframe-modal-head{padding:14px 16px}
}
</style>
</head>
<body>

<!-- ═══ LOGIN ═══ -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">
      <div class="login-logo-mark">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </div>
    </div>
    <h1 class="login-title">DIVINE</h1>
    <p class="login-sub">Guest House · Staff Portal</p>
    <form id="loginForm">
      <div class="login-field">
        <span class="field-icon icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 6L2 7"/></svg></span>
        <input type="email" id="loginEmail" placeholder="Email address" required>
      </div>
      <div class="login-field">
        <span class="field-icon icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
        <input type="password" id="loginPass" placeholder="Password" required>
      </div>
      <button type="submit" class="btn-login">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
        Sign In
      </button>
    </form>
    <p class="login-error" id="loginError">Invalid email or password</p>
  </div>
</div>

<!-- ═══ APP ═══ -->
<div id="app">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="header-logo-mark">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </div>
      <div>
        <div class="header-brand">DIVINE <span>Guest House</span></div>
      </div>
    </div>
    <div class="header-right">
      <div class="notif-bell" id="notifBell">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        <div class="notif-badge hidden" id="notifBadge">0</div>
      </div>
      <button class="hdr-btn primary" id="btnCheckin">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        <span class="btn-label">Check In</span>
      </button>
      <button class="hdr-btn" id="btnLogout">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        <span class="btn-label">Logout</span>
      </button>
    </div>
  </div>

  <!-- Notification Panel -->
  <div class="notif-panel" id="notifPanel">
    <div class="np-head">
      <div class="np-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        Notifications
      </div>
      <div class="np-tabs">
        <div class="np-tab active" data-tab="latest" id="npTabLatest">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          Latest
          <span class="np-tab-badge" id="npBadgeLatest">0</span>
        </div>
        <div class="np-tab" data-tab="recent" id="npTabRecent">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Recent
          <span class="np-tab-badge hidden" id="npBadgeRecent">0</span>
        </div>
      </div>
      <div class="np-clear" id="npClear">Mark all as read</div>
    </div>
    <div class="np-list" id="npList"></div>
  </div>

  <!-- Main -->
  <div class="main">

    <!-- Stats -->
    <div class="stats-row" id="statsRow">
      <div class="stat-card">
        <div class="stat-top">
          <div class="stat-icon-wrap"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
          <div class="stat-label">Revenue</div>
        </div>
        <div class="stat-val" id="statRevenue">Rs 0</div>
        <div class="stat-sub">Today's total</div>
      </div>
      <div class="stat-card">
        <div class="stat-top">
          <div class="stat-icon-wrap"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
          <div class="stat-label">Bookings</div>
        </div>
        <div class="stat-val" id="statBookings">0</div>
        <div class="stat-sub">Selected date</div>
      </div>
      <div class="stat-card">
        <div class="stat-top">
          <div class="stat-icon-wrap"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
          <div class="stat-label">Pending Pay</div>
        </div>
        <div class="stat-val" id="statPending">Rs 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-top">
          <div class="stat-icon-wrap"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/></svg></div>
          <div class="stat-label">Day Slots</div>
        </div>
        <div class="stat-val" id="statDay">0</div>
        <div class="stat-sub">Available now</div>
      </div>
      <div class="stat-card">
        <div class="stat-top">
          <div class="stat-icon-wrap"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></div>
          <div class="stat-label">Night Slots</div>
        </div>
        <div class="stat-val" id="statNight">0</div>
        <div class="stat-sub">Available now</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-row">
      <button class="quick-btn" id="qToday">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Today
      </button>
      <button class="quick-btn" id="qPending">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Pending Check-ins
      </button>
      <button class="quick-btn" id="qActive">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Active Guests
      </button>
    </div>

    <!-- Date Selector -->
    <div class="section">
      <div class="section-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Select Date
      </div>
      <div class="date-scroll" id="dateScroll"></div>
    </div>

    <!-- Room Availability -->
    <div class="section">
      <div class="section-head">
        <div class="section-title">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Rooms
        </div>
        <div class="filter-tabs">
          <div class="filter-tab active" data-filter="Daycation" id="ftDay">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/></svg>
            Day
          </div>
          <div class="filter-tab" data-filter="Staycation" id="ftNight">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            Night
          </div>
        </div>
      </div>
      <div class="room-grid" id="roomGrid"></div>
    </div>

    <!-- Bookings List -->
    <div class="section">
      <div class="section-head">
        <div class="section-title">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>
          Bookings
        </div>
        <div class="search-wrap">
          <span class="s-icon icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
          <input type="text" id="searchInput" placeholder="Search name, phone, ref…">
        </div>
      </div>
      <div class="bookings-list" id="bookingsList"></div>
    </div>
  </div>
</div>

<!-- ═══ CHECK-IN MODAL ═══ -->
<div class="modal-overlay" id="checkinOverlay">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-head-left">
        <div class="modal-head-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        </div>
        <div>
          <div class="modal-title">Check In Guest</div>
          <div class="modal-sub">Search and confirm arrival</div>
        </div>
      </div>
      <button class="modal-close" id="checkinClose">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <!-- Search pending guests -->
      <div class="checkin-search">
        <span class="cs-icon icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
        <input type="text" id="checkinSearch" placeholder="Search by name, phone or ref…" autocomplete="off">
      </div>
      <!-- Pending guest list -->
      <div class="pending-list" id="pendingList"></div>
      <!-- Selected guest card -->
      <div class="guest-card" id="guestCard">
        <div class="gc-header">
          <div class="gc-avatar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="8" r="4"/></svg>
          </div>
          <div>
            <div class="gc-name" id="gcName">—</div>
            <div class="gc-ref" id="gcRef">—</div>
          </div>
        </div>
        <div class="gc-details" id="gcDetails"></div>
      </div>
      <!-- Doc upload -->
      <div class="doc-upload" id="docUploadSection">
        <div class="doc-upload-label">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          ID / Document
        </div>
        <div class="drop-zone" id="dropZone">
          <input type="file" id="docFileInput" accept="image/*,.pdf">
          <div class="dz-icon icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
          <div class="dz-text">Drag & drop or click to upload</div>
          <div class="dz-sub">Photo ID, Passport, Aadhaar, etc.</div>
        </div>
        <div class="doc-preview hidden" id="docPreview">
          <span class="dp-icon icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span>
          <span class="dp-name" id="dpName">document.jpg</span>
          <span class="dp-size" id="dpSize">0 KB</span>
          <span class="dp-remove" id="dpRemove"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span>
        </div>
      </div>
      <!-- Footer -->
      <div class="modal-footer">
        <button class="btn-confirm" id="btnConfirmCheckin" disabled>
          <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          Confirm Check-In
        </button>
        <button class="btn-cancel" id="checkinCancel">Cancel</button>
      </div>
      <!-- New check-in button → opens iframe modal -->
      <button type="button" class="new-checkin-link" id="btnNewCheckinForm">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
        New Check-in Form
      </button>
    </div>
  </div>
</div>

<!-- ═══ EDIT MODAL ═══ -->
<div class="modal-overlay" id="editOverlay">
  <div class="modal edit-modal">
    <div class="modal-head">
      <div class="modal-head-left">
        <div class="modal-head-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </div>
        <div>
          <div class="modal-title" id="editTitle">Edit Booking</div>
          <div class="modal-sub">Modify booking details</div>
        </div>
      </div>
      <button class="modal-close" id="editClose">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="editForm">
        <div class="form-row">
          <div class="form-group"><label>Name</label><input type="text" id="eName" required></div>
         <div class="form-group"><label>Phone</label><input type="tel" id="ePhone"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Room</label>
            <select id="eRoom">
              <option value="Cozy Mini">Cozy Mini</option>
              <option value="Compact Twin">Compact Twin</option>
              <option value="Convenient Queen">Convenient Queen</option>
            </select>
          </div>
          <div class="form-group"><label>Stay Type</label>
            <select id="eType">
              <option value="Daycation">Day Time</option>
              <option value="Staycation">Night Time</option>
              <option value="Full Stay">Full Stay</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Date</label><input type="date" id="eDate" required></div>
          <div class="form-group"><label>Arrival Time</label><input type="time" id="eTime"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Amount (for 2)</label><input type="number" id="eAmount" required></div>
          <div class="form-group"><label>Payment</label>
            <select id="ePayment"><option value="unpaid">Unpaid</option><option value="paid">Paid</option></select>
          </div>
        </div>
        <div class="form-group"><label>Status</label>
          <select id="eStatus"><option value="pending">Pending</option><option value="checked-in">Checked In</option><option value="checked-out">Checked Out</option></select>
        </div>

        <!-- Document Section in Edit Modal -->
        <div class="edit-doc-section">
          <div class="edit-doc-label">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            Guest Document
          </div>
          <!-- Preview when doc exists -->
          <div class="edit-doc-preview" id="editDocPreview">
            <img class="edit-doc-img" id="editDocImg" alt="Guest document">
            <div class="edit-doc-info">
              <span class="edit-doc-name" id="editDocName">Document</span>
              <div class="edit-doc-actions">
                <button type="button" class="edit-doc-btn view" id="editDocView">
                  <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                  View Full
                </button>
                <button type="button" class="edit-doc-btn change" id="editDocChange">
                  <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                  Change
                </button>
              </div>
            </div>
          </div>
          <!-- Shown when no doc -->
          <div class="edit-doc-none" id="editDocNone">No document uploaded</div>
          <!-- Upload zone (shown after tapping Change or when no doc) -->
          <div class="edit-doc-upload" id="editDocUpload" style="display:none">
            <input type="file" id="editDocFileInput" accept="image/*,.pdf">
            <div class="edit-doc-upload-text">Click to upload new document</div>
          </div>
        </div>

        <button type="submit" class="btn-save">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          Save Changes
        </button>
      </form>
    </div>
  </div>
</div>

<!-- ═══ IFRAME MODAL (New Check-in Form) ═══ -->
<div class="iframe-overlay" id="iframeOverlay">
  <div class="iframe-modal">
    <div class="iframe-modal-head">
      <div class="iframe-modal-head-left">
        <div class="iframe-modal-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
        </div>
        <div>
          <div class="iframe-modal-title">New Check-in Form</div>
          <div class="iframe-modal-sub">Create a fresh booking</div>
        </div>
      </div>
      <button class="iframe-modal-close" id="iframeClose">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <!-- Loading state while iframe loads -->
    <div class="iframe-loading" id="iframeLoading">
      <div class="spinner dark"></div>
      <p>Loading check-in form…</p>
    </div>
    <!-- The actual iframe (hidden until loaded) -->
    <iframe id="checkinIframe" src="" style="display:none" scrolling="yes"></iframe>
  </div>
</div>

<!-- ═══ TOAST ═══ -->
<div class="toast" id="toast">
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
  <span id="toastMsg">Done</span>
</div>

<!-- ═══ SCRIPTS ═══ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
'use strict';

/* ─── Config ─── */
const SB_URL='https://fzwnglhxtmtltpysdzma.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6d25nbGh4dG10bHRweXNkem1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODE0MzAsImV4cCI6MjA4NDE1NzQzMH0.PuES2nphqkKU-FqzBge6LlptVibSfeTQcUExEdfTleg';
const sb=window.supabase.createClient(SB_URL,SB_KEY);

const ROOMS=['Cozy Mini','Compact Twin','Convenient Queen'];
const CAPACITY={'Cozy Mini':5,'Compact Twin':2,'Convenient Queen':1};
const PRICING={
  'Cozy Mini':{'Daycation':1200,'Staycation':1500,'Full Stay':2500},
  'Compact Twin':{'Daycation':1400,'Staycation':1700,'Full Stay':2900},
  'Convenient Queen':{'Daycation':1700,'Staycation':2000,'Full Stay':3500}
};
const TIMES={'Daycation':'12:00 PM – 5:00 PM','Staycation':'6:00 PM – 11:00 AM','Full Stay':'12:00 PM – 11:00 AM'};

/* ─── State ─── */
let bookings=[];
let notifications=[];
let selectedDate=new Date().toISOString().split('T')[0];
let currentFilter='Daycation';
let currentNotifTab='latest';
let lastBookingCount=0;
let initialized=false;
// Check-in state
let checkinBooking=null;
let uploadedFile=null;
// Edit state
let editingId=null;
let editingDocUrl=null;
let editNewDocFile=null;

/* ─── Helpers ─── */
function fmtDate(d){
  const dt=new Date(d+'T00:00:00');
  return dt.toLocaleDateString('en-US',{month:'short',day:'numeric'});
}
function fmtTime24(t){if(!t)return'—';const[h,m]=t.split(':');const hr=parseInt(h);const ampm=hr>=12?'PM':'AM';return`${hr%12||12}:${m} ${ampm}`}
function timeAgo(ts){
  const s=Math.floor((Date.now()-new Date(ts))/1000);
  if(s<60)return'Just now';if(s<3600)return Math.floor(s/60)+'m ago';
  if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';
}
function fmtBytes(b){return b<1024?b+' B':b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB'}

/* ─── Toast ─── */
let toastTimeout;
function toast(msg,type='success'){
  const el=document.getElementById('toast');
  el.className='toast '+type;
  document.getElementById('toastMsg').textContent=msg;
  el.classList.add('show');
  clearTimeout(toastTimeout);
  toastTimeout=setTimeout(()=>el.classList.remove('show'),2600);
}

/* ─── LOGIN ─── */
document.getElementById('loginForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const btn=e.target.querySelector('button');
  btn.innerHTML='<span class="spinner"></span> Signing in…';
  const{error}=await sb.auth.signInWithPassword({
    email:document.getElementById('loginEmail').value,
    password:document.getElementById('loginPass').value
  });
  if(!error){
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('app').classList.add('visible');
    await init();
  } else {
    document.getElementById('loginError').classList.add('show');
    btn.innerHTML='Sign In';
  }
});

/* ─── INIT ─── */
async function init(){
  if(initialized)return;
  initialized=true;
  buildDates();
  await loadBookings();
  wireEvents();
  // Realtime
  sb.channel('bookings-rt')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'bookings'},p=>onNewBooking(p.new))
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'bookings'},()=>loadBookings())
    .on('postgres_changes',{event:'DELETE',schema:'public',table:'bookings'},()=>loadBookings())
    .subscribe();
}

/* ─── DATES ─── */
function buildDates(){
  const c=document.getElementById('dateScroll');
  const today=new Date();let h='';
  for(let i=0;i<14;i++){
    const d=new Date(today);d.setDate(today.getDate()+i);
    const ds=d.toISOString().split('T')[0];
    const active=ds===selectedDate?'active':'';
    const day=i===0?'Today':i===1?'Tomr':d.toLocaleDateString('en-US',{weekday:'short'});
    h+=`<div class="date-btn ${active}" data-date="${ds}"><div class="date-day">${day}</div><div class="date-num">${d.getDate()}</div></div>`;
  }
  c.innerHTML=h;
  c.querySelectorAll('.date-btn').forEach(b=>b.addEventListener('click',function(){
    selectedDate=this.dataset.date;buildDates();renderAll();
  }));
}

/* ─── LOAD ─── */
async function loadBookings(){
  const{data,error}=await sb.from('bookings').select('*').order('created_at',{ascending:false});
  if(!error&&data){
    if(bookings.length>0&&data.length>lastBookingCount){
      data.slice(0,data.length-lastBookingCount).forEach(b=>{
        if(!notifications.find(n=>n.id===b.id)){
          notifications.unshift({id:b.id,booking:b,read:false,timestamp:new Date(b.created_at)});
          saveNotifHistory(b);
        }
      });
      notifications=notifications.slice(0,100);
      updateBadge();renderNotifs();
    }
    bookings=data;lastBookingCount=data.length;renderAll();
  }
}

function onNewBooking(b){
  notifications.unshift({id:b.id,booking:b,read:false,timestamp:new Date()});
  notifications=notifications.slice(0,100);
  saveNotifHistory(b);
  updateBadge();renderNotifs();
  loadBookings();
}

/* ─── RENDER ALL ─── */
function renderAll(){renderStats();renderRooms();renderBookings();}

/* ─── STATS ─── */
function renderStats(){
  const today=bookings.filter(b=>b.check_in_date===selectedDate&&b.status!=='cancelled');
  const rev=today.reduce((s,b)=>s+(b.total_amount||0),0);
  const pending=bookings.filter(b=>b.payment_status==='unpaid'&&b.status!=='cancelled').reduce((s,b)=>s+(b.total_amount||0),0);
  const active=bookings.filter(b=>b.check_in_date===selectedDate&&b.status!=='checked-out'&&b.status!=='cancelled');
  const dayB=active.filter(b=>b.stay_type==='Daycation').length;
  const nightB=active.filter(b=>b.stay_type==='Staycation'||b.stay_type==='Full Stay').length;
  const totalCap=Object.values(CAPACITY).reduce((a,b)=>a+b,0);
  document.getElementById('statRevenue').textContent='Rs '+rev.toLocaleString();
  document.getElementById('statBookings').textContent=today.length;
  document.getElementById('statPending').textContent='Rs '+pending.toLocaleString();
  document.getElementById('statDay').textContent=Math.max(0,totalCap-dayB);
  document.getElementById('statNight').textContent=Math.max(0,totalCap-nightB);
}

/* ─── ROOMS ─── */
function renderRooms(){
  const active=bookings.filter(b=>b.check_in_date===selectedDate&&b.status!=='checked-out'&&b.status!=='cancelled');
  const usage={};ROOMS.forEach(r=>usage[r]={day:0,night:0});
  active.forEach(b=>{if(usage[b.room_type]){if(b.stay_type==='Daycation')usage[b.room_type].day++;else usage[b.room_type].night++;}});
  let h='';
  ROOMS.forEach(r=>{
    const used=currentFilter==='Daycation'?usage[r].day:usage[r].night;
    const avail=CAPACITY[r]-used;
    const cls=avail>0?'available':'busy';
    h+=`<div class="room-card ${cls}"${avail>0?` data-room="${r}"`:''}><div class="room-icon-wrap">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
    <div class="room-name">${r}</div><div class="room-status">${avail>0?avail+' Available':'Full'}</div><div class="room-cap">Cap: ${CAPACITY[r]}</div></div>`;
  });
  document.getElementById('roomGrid').innerHTML=h;
}

/* ─── BOOKINGS LIST ─── */
let activeStatusFilter=null;

 function renderBookings(search=''){
  const c=document.getElementById('bookingsList');
  // Filter by selected date first
  let list=bookings.filter(b=>b.status!=='cancelled' && b.check_in_date===selectedDate);

  // Then keep your existing activeStatusFilter logic
  if(activeStatusFilter)list=list.filter(b=>b.status===activeStatusFilter); if(search){const q=search.toLowerCase();list=list.filter(b=>b.full_name.toLowerCase().includes(q)||b.phone_number.includes(q)||(b.qr_token||'').toLowerCase().includes(q));}
  if(!list.length){
    c.innerHTML=`<div class="empty-state"><div class="empty-icon-wrap"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div><p>No bookings found</p></div>`;
    return;
  }
  let h='';
  list.forEach(b=>{
    const badgeCls='badge-'+b.status;
    const badgeLabel=b.status==='checked-in'?'Checked In':b.status==='checked-out'?'Checked Out':'Pending';
    // doc icon shown if guest_photo_url exists
    const docIcon=b.guest_photo_url?`<span style="display:inline-flex;align-items:center;margin-left:2px" title="Has document"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></span>`:'';
    h+=`<div class="booking-card">
      <div class="b-avatar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="8" r="4"/></svg></div>
      <div class="b-info">
        <div class="b-name">${b.full_name}${docIcon}<span class="badge ${badgeCls}">${badgeLabel}</span></div>
        <div class="b-meta">
          <span class="b-meta-item"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.12 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>${b.phone_number}</span>
          <span class="b-meta-sep"></span>
          <span class="b-meta-item"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>${b.room_type}</span>
          <span class="b-meta-sep"></span>
          <span class="b-meta-item"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>${fmtTime24(b.arrival_time)}</span>
          <span class="b-meta-sep"></span>
          <span class="b-meta-item"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${b.stay_type==='Daycation'?'<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>':'<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>'}</svg>${b.stay_type}</span>
          <span class="b-meta-sep"></span>
          <span class="b-meta-item"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Rs ${(b.total_amount||0).toLocaleString()}</span>
          <span class="b-meta-sep"></span>
          <span class="b-meta-item" style="font-family:'DM Mono',monospace;font-size:11px;color:var(--ink4)">${b.qr_token||'—'}</span>
        </div>
      </div>
      <div class="b-actions">
        ${b.status==='pending'?`<button class="act-btn checkin" data-id="${b.id}"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span>Check In</span></button>`:''}
        ${b.status==='checked-in'?`<button class="act-btn checkout" data-id="${b.id}"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg><span>Check Out</span></button>`:''}
        <button class="act-btn edit" data-id="${b.id}"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg><span>Edit</span></button>
        <button class="act-btn del" data-id="${b.id}" data-name="${b.full_name}"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg><span>Del</span></button>
      </div>
    </div>`;
  });
  c.innerHTML=h;
  // Wire buttons
  c.querySelectorAll('.act-btn').forEach(btn=>{
    btn.addEventListener('click',async function(){
      const id=this.dataset.id;const action=this.classList[1];
      if(action==='checkin'){await updateStatus(id,'checked-in');toast('Guest checked in');}
      else if(action==='checkout'){await updateStatus(id,'checked-out');toast('Guest checked out');}
      else if(action==='edit'){openEdit(id);}
      else if(action==='del'){
        if(confirm('Delete booking for '+this.dataset.name+'?')){
          await sb.from('bookings').delete().eq('id',id);await loadBookings();toast('Booking deleted','error');
        }
      }
    });
  });
}

async function updateStatus(id,status){
  await sb.from('bookings').update({status}).eq('id',id);
  await loadBookings();
}

/* ─── WIRE GLOBAL EVENTS ─── */
function wireEvents(){
  // Logout
  document.getElementById('btnLogout').addEventListener('click',async()=>{
    await sb.auth.signOut();
    document.getElementById('app').classList.remove('visible');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('loginForm').reset();
    initialized=false;notifications=[];bookings=[];
  });

  // Quick buttons
  document.getElementById('qToday').addEventListener('click',()=>{
    selectedDate=new Date().toISOString().split('T')[0];
    activeStatusFilter=null;
    document.getElementById('qPending').classList.remove('active');
    document.getElementById('qActive').classList.remove('active');
    buildDates();renderAll();
  });
  document.getElementById('qPending').addEventListener('click',()=>{activeStatusFilter='pending';document.getElementById('qPending').classList.add('active');document.getElementById('qActive').classList.remove('active');renderBookings(document.getElementById('searchInput').value);});
  document.getElementById('qActive').addEventListener('click',()=>{activeStatusFilter='checked-in';document.getElementById('qActive').classList.add('active');document.getElementById('qPending').classList.remove('active');renderBookings(document.getElementById('searchInput').value);});

  // Search
  document.getElementById('searchInput').addEventListener('input',e=>renderBookings(e.target.value));

  // Filter tabs
  document.querySelectorAll('.filter-tab').forEach(t=>{
    t.addEventListener('click',function(){
      currentFilter=this.dataset.filter;
      document.querySelectorAll('.filter-tab').forEach(x=>x.classList.remove('active'));
      this.classList.add('active');renderRooms();
    });
  });

  // Notif bell
  document.getElementById('notifBell').addEventListener('click',e=>{e.stopPropagation();document.getElementById('notifPanel').classList.toggle('show');});
  document.addEventListener('click',e=>{
    if(!document.getElementById('notifPanel').contains(e.target)&&!document.getElementById('notifBell').contains(e.target))
      document.getElementById('notifPanel').classList.remove('show');
  });
  // Notif tabs
  document.querySelectorAll('.np-tab').forEach(t=>{
    t.addEventListener('click',function(){
      currentNotifTab=this.dataset.tab;
      document.querySelectorAll('.np-tab').forEach(x=>x.classList.remove('active'));
      this.classList.add('active');renderNotifs();
    });
  });
  document.getElementById('npClear').addEventListener('click',()=>{notifications.forEach(n=>n.read=true);updateBadge();renderNotifs();});

  /* ─── CHECK-IN MODAL ─── */
  document.getElementById('btnCheckin').addEventListener('click',openCheckin);
  document.getElementById('checkinClose').addEventListener('click',closeCheckin);
  document.getElementById('checkinCancel').addEventListener('click',closeCheckin);
  document.getElementById('checkinOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeCheckin();});

  // Search pending guests
  document.getElementById('checkinSearch').addEventListener('input',filterPending);

  // Drop zone
  const dz=document.getElementById('dropZone');
  const fi=document.getElementById('docFileInput');
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('dragover');});
  dz.addEventListener('dragleave',()=>dz.classList.remove('dragover'));
  dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('dragover');if(e.dataTransfer.files[0])setUploadedFile(e.dataTransfer.files[0]);});
  fi.addEventListener('change',e=>{if(e.target.files[0])setUploadedFile(e.target.files[0]);});
  document.getElementById('dpRemove').addEventListener('click',removeUploadedFile);

  // Confirm check-in
  document.getElementById('btnConfirmCheckin').addEventListener('click',doCheckin);

  /* ─── NEW CHECK-IN FORM → iframe modal ─── */
  document.getElementById('btnNewCheckinForm').addEventListener('click',openIframeModal);
  document.getElementById('iframeClose').addEventListener('click',closeIframeModal);
  document.getElementById('iframeOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeIframeModal();});

  /* ─── EDIT MODAL ─── */
  document.getElementById('editClose').addEventListener('click',closeEdit);
  document.getElementById('editOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeEdit();});
  document.getElementById('eRoom').addEventListener('change',autoPrice);
  document.getElementById('eType').addEventListener('change',()=>{autoPrice();autoTime();});
  document.getElementById('editForm').addEventListener('submit',saveEdit);

  /* ─── EDIT DOC actions ─── */
  document.getElementById('editDocView').addEventListener('click',()=>{
    if(editingDocUrl)window.open(editingDocUrl,'_blank');
  });
  document.getElementById('editDocChange').addEventListener('click',()=>{
    document.getElementById('editDocUpload').style.display='block';
    // small delay so the upload zone is painted before we trigger click
    setTimeout(()=>document.getElementById('editDocFileInput').click(),100);
  });
  document.getElementById('editDocFileInput').addEventListener('change',e=>{
    if(e.target.files[0]){
      editNewDocFile=e.target.files[0];
      const reader=new FileReader();
      reader.onload=ev=>{
        document.getElementById('editDocImg').src=ev.target.result;
        document.getElementById('editDocName').textContent=editNewDocFile.name;
        document.getElementById('editDocPreview').classList.add('show');
        document.getElementById('editDocNone').style.display='none';
        document.getElementById('editDocUpload').style.display='none';
        toast('New document selected','success');
      };
      reader.readAsDataURL(editNewDocFile);
    }
  });
  // When no doc exists, clicking the "none" block should also open file picker
  document.getElementById('editDocNone').addEventListener('click',()=>{
    document.getElementById('editDocUpload').style.display='block';
    setTimeout(()=>document.getElementById('editDocFileInput').click(),100);
  });
  document.getElementById('editDocNone').style.cursor='pointer';
}

/* ═══════════════════ IFRAME MODAL ═══════════════════ */
function openIframeModal(){
  const overlay=document.getElementById('iframeOverlay');
  const iframe=document.getElementById('checkinIframe');
  const loading=document.getElementById('iframeLoading');

  // show loading, hide iframe
  loading.style.display='flex';
  iframe.style.display='none';
  iframe.src='';

  overlay.classList.add('show');

  // point iframe at the external check-in page
  iframe.onload=()=>{
    loading.style.display='none';
    iframe.style.display='block';
  };
  // Use requestAnimationFrame so the overlay is painted before we start loading
  requestAnimationFrame(()=>{
    iframe.src='checkintry.html';
  });
}
function closeIframeModal(){
  document.getElementById('iframeOverlay').classList.remove('show');
  // stop any loading / free resources
  const iframe=document.getElementById('checkinIframe');
  iframe.src='';
  iframe.onload=null;
}

/* ═══════════════════ CHECK-IN FLOW ═══════════════════ */
function openCheckin(){
  checkinBooking=null;uploadedFile=null;
  document.getElementById('checkinOverlay').classList.add('show');
  document.getElementById('checkinSearch').value='';
  document.getElementById('guestCard').classList.remove('show');
  document.getElementById('btnConfirmCheckin').disabled=true;
  document.getElementById('docPreview').classList.add('hidden');
  document.getElementById('docFileInput').value='';
  filterPending();
  setTimeout(()=>document.getElementById('checkinSearch').focus(),200);
}
function closeCheckin(){
  document.getElementById('checkinOverlay').classList.remove('show');
  checkinBooking=null;uploadedFile=null;
}

function filterPending(){
  const q=document.getElementById('checkinSearch').value.toLowerCase();
  let list=bookings.filter(b=>b.status==='pending');
  if(q)list=list.filter(b=>b.full_name.toLowerCase().includes(q)||b.phone_number.includes(q)||(b.qr_token||'').toLowerCase().includes(q));
  const pl=document.getElementById('pendingList');
  if(!list.length){
    pl.classList.remove('hidden');
    pl.innerHTML='<div class="pending-empty">No pending guests found</div>';
    return;
  }
  pl.classList.remove('hidden');
  let h='';
  list.forEach(b=>{
    const sel=checkinBooking&&checkinBooking.id===b.id?'selected':'';
    h+=`<div class="pending-item ${sel}" data-id="${b.id}">
      <div class="pi-avatar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="8" r="4"/></svg></div>
      <div class="pi-info"><div class="pi-name">${b.full_name}</div><div class="pi-detail">${b.phone_number} · ${b.room_type} · ${TIMES[b.stay_type]}</div></div>
      <div class="pi-badge"><span class="badge badge-pending">Pending</span></div>
    </div>`;
  });
  pl.innerHTML=h;
  pl.querySelectorAll('.pending-item').forEach(item=>{
    item.addEventListener('click',()=>{
      const b=bookings.find(x=>x.id===parseInt(item.dataset.id));
      if(b)selectGuest(b);
    });
  });
}

function selectGuest(b){
  checkinBooking=b;
  document.getElementById('pendingList').classList.add('hidden');
  document.getElementById('checkinSearch').value=b.full_name;
  document.getElementById('gcName').textContent=b.full_name;
  document.getElementById('gcRef').textContent=b.qr_token||'—';
  document.getElementById('gcDetails').innerHTML=`
    <div class="gc-detail"><span class="gcd-icon icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.12 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg></span><div><span class="gcd-label">Phone</span><span class="gcd-val">${b.phone_number}</span></div></div>
    <div class="gc-detail"><span class="gcd-icon icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span><div><span class="gcd-label">Room</span><span class="gcd-val">${b.room_type}</span></div></div>
    <div class="gc-detail"><span class="gcd-icon icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span><div><span class="gcd-label">Arrival</span><span class="gcd-val">${fmtTime24(b.arrival_time)} · ${TIMES[b.stay_type]}</span></div></div>
    <div class="gc-detail"><span class="gcd-icon icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></span><div><span class="gcd-label">Amount</span><span class="gcd-val">Rs ${(b.total_amount||0).toLocaleString()}</span></div></div>
  `;
  document.getElementById('guestCard').classList.add('show');
  document.getElementById('btnConfirmCheckin').disabled=false;
}

function setUploadedFile(file){
  uploadedFile=file;
  document.getElementById('dpName').textContent=file.name;
  document.getElementById('dpSize').textContent=fmtBytes(file.size);
  document.getElementById('docPreview').classList.remove('hidden');
}
function removeUploadedFile(){
  uploadedFile=null;
  document.getElementById('docFileInput').value='';
  document.getElementById('docPreview').classList.add('hidden');
}

/* Upload helper – returns public URL or null */
async function uploadDocToStorage(file){
  const ext=file.name.split('.').pop();
  const path=`${Date.now()}_${Math.random().toString(36).slice(2,8)}.${ext}`;
  const{data:uploadData,error:ue}=await sb.storage.from('guest_photos').upload(path,file,{  // ← Changed
    cacheControl:'3600',upsert:false
  });
  if(ue){console.error('Upload error:',ue);return null;}
  if(uploadData){
    const{data:urlData}=sb.storage.from('guest_photos').getPublicUrl(path);  // ← And here
    return urlData.publicUrl;
  }
  return null;
}

async function doCheckin(){
  if(!checkinBooking)return;
  const btn=document.getElementById('btnConfirmCheckin');
  btn.disabled=true;
  btn.innerHTML='<span class="spinner"></span> Checking in…';
  try{
    let docUrl=checkinBooking.guest_photo_url||null;

    // Upload document if staff attached one
    if(uploadedFile){
      const url=await uploadDocToStorage(uploadedFile);
      if(url) docUrl=url;
      else { toast('Document upload failed – continuing without it','error'); }
    }

    await sb.from('bookings').update({status:'checked-in',guest_photo_url:docUrl}).eq('id',checkinBooking.id);
    await loadBookings();
    toast('Guest checked in successfully');
    closeCheckin();
  } catch(err){
    console.error(err);toast('Check-in failed','error');
    btn.disabled=false;btn.innerHTML='<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Confirm Check-In';
  }
}

/* ═══════════════════ EDIT MODAL ═══════════════════ */
function openEdit(id){
  const b=bookings.find(x=>x.id===parseInt(id));
  if(!b)return;
  editingId=b.id;
  editingDocUrl=b.guest_photo_url||null;
  editNewDocFile=null;

  document.getElementById('editTitle').textContent='Edit – '+b.full_name;
  document.getElementById('eName').value=b.full_name||'';
  document.getElementById('ePhone').value=b.phone_number||'';
  document.getElementById('eRoom').value=b.room_type||'Cozy Mini';
  document.getElementById('eType').value=b.stay_type||'Daycation';
  document.getElementById('eDate').value=b.check_in_date||selectedDate;
  document.getElementById('eTime').value=b.arrival_time||'';
  document.getElementById('eAmount').value=b.total_amount||'';
  document.getElementById('ePayment').value=b.payment_status||'unpaid';
  document.getElementById('eStatus').value=b.status||'pending';

  // Document section
  if(editingDocUrl){
    document.getElementById('editDocImg').src=editingDocUrl;
    document.getElementById('editDocName').textContent='Guest Document';
    document.getElementById('editDocPreview').classList.add('show');
    document.getElementById('editDocNone').style.display='none';
  } else {
    document.getElementById('editDocPreview').classList.remove('show');
    document.getElementById('editDocNone').style.display='block';
  }
  document.getElementById('editDocUpload').style.display='none';
  document.getElementById('editDocFileInput').value='';

  document.getElementById('editOverlay').classList.add('show');
}
function closeEdit(){
  document.getElementById('editOverlay').classList.remove('show');
  editingId=null;editingDocUrl=null;editNewDocFile=null;
}
function autoPrice(){
  const r=document.getElementById('eRoom').value;
  const t=document.getElementById('eType').value;
  if(PRICING[r]&&PRICING[r][t])document.getElementById('eAmount').value=PRICING[r][t];
}
function autoTime(){
  const t=document.getElementById('eType').value;
  const ti=document.getElementById('eTime');
  if(!ti.value){ti.value=t==='Daycation'?'12:00':t==='Staycation'?'18:00':'12:00';}
}

async function saveEdit(e){
  e.preventDefault();
  const btn=e.target.querySelector('button[type=submit]');
  btn.innerHTML='<span class="spinner dark"></span> Saving…';
  try{
    let docUrl=editingDocUrl;

    // Upload new document if staff picked one
    if(editNewDocFile){
      const url=await uploadDocToStorage(editNewDocFile);
      if(url) docUrl=url;
      else {
        toast('Document upload failed','error');
        btn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Save Changes';
        return;
      }
    }

    const phoneValue = document.getElementById('ePhone').value.trim();
    
    const data={
      full_name:document.getElementById('eName').value,
      phone_number: phoneValue || null,  // ← Changed: allow null if empty
      room_type:document.getElementById('eRoom').value,
      stay_type:document.getElementById('eType').value,
      check_in_date:document.getElementById('eDate').value,
      arrival_time:document.getElementById('eTime').value,
      total_amount:parseFloat(document.getElementById('eAmount').value),
      base_amount:parseFloat(document.getElementById('eAmount').value),
      payment_status:document.getElementById('ePayment').value,
      status:document.getElementById('eStatus').value,
      guest_photo_url:docUrl,
      discount_percent:0
    };

    await sb.from('bookings').update(data).eq('id',editingId);
    await loadBookings();
    toast('Booking updated');
    closeEdit();
  } catch(err){
    console.error(err);toast('Save failed','error');
    btn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Save Changes';
  }
}

/* ═══════════════════ NOTIFICATIONS ═══════════════════ */
function saveNotifHistory(b){
  try{
    const h=JSON.parse(localStorage.getItem('dghNotifHistory')||'{}');
    const dk=b.check_in_date;
    if(!h[dk])h[dk]=[];
    if(!h[dk].some(x=>x.id===b.id))h[dk].push({id:b.id,booking:b,timestamp:new Date().toISOString()});
    localStorage.setItem('dghNotifHistory',JSON.stringify(h));
  } catch(e){console.error(e);}
}
function loadNotifHistory(){
  try{
    const h=JSON.parse(localStorage.getItem('dghNotifHistory')||'{}');
    let all=[];
    Object.keys(h).forEach(dk=>h[dk].forEach(item=>all.push({id:item.id,booking:item.booking,read:true,timestamp:new Date(item.timestamp)})));
    all.sort((a,b)=>b.timestamp-a.timestamp);return all;
  } catch(e){return[];}
}
function updateBadge(){
  const oneHourAgo=new Date(Date.now()-3600000);
  const latestUnread=notifications.filter(n=>!n.read&&new Date(n.timestamp)>oneHourAgo).length;
  const badge=document.getElementById('notifBadge');
  if(latestUnread>0){badge.textContent=latestUnread>99?'99+':latestUnread;badge.classList.remove('hidden');}else badge.classList.add('hidden');
  const bl=document.getElementById('npBadgeLatest');
  if(bl){bl.textContent=latestUnread;bl.classList.toggle('hidden',!latestUnread);}
  const br=document.getElementById('npBadgeRecent');
  if(br){const rc=loadNotifHistory().length;br.textContent=rc>999?'999+':rc;br.classList.toggle('hidden',!rc);}
}
function renderNotifs(){
  const c=document.getElementById('npList');
  const oneHourAgo=new Date(Date.now()-3600000);
  let list;
  if(currentNotifTab==='latest'){
    list=notifications.filter(n=>new Date(n.timestamp)>oneHourAgo);
  } else {
    list=loadNotifHistory();
  }
  if(!list.length){
    c.innerHTML=`<div class="np-empty"><div class="np-empty-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></div><p>No notifications</p></div>`;
    return;
  }
  let h='';
  if(currentNotifTab==='recent'){
    const groups={};
    list.forEach(n=>{const dk=n.booking.check_in_date;if(!groups[dk])groups[dk]=[];groups[dk].push(n);});
    Object.keys(groups).sort((a,b)=>new Date(b)-new Date(a)).forEach(dk=>{
      h+=`<div class="np-date-header">${fmtDate(dk)}</div>`;
      groups[dk].forEach(n=>h+=renderNotifItem(n));
    });
  } else {
    list.forEach(n=>h+=renderNotifItem(n));
  }
  c.innerHTML=h;
  c.querySelectorAll('.np-btn.done').forEach(btn=>{
    btn.addEventListener('click',e=>{
      e.stopPropagation();
      const n=notifications.find(x=>x.id===parseInt(btn.dataset.id));
      if(n)n.read=true;
      updateBadge();renderNotifs();
    });
  });
  c.querySelectorAll('.np-btn.view').forEach(btn=>{
    btn.addEventListener('click',e=>{
      e.stopPropagation();
      const n=notifications.find(x=>x.id===parseInt(btn.dataset.id));
      if(n)n.read=true;
      updateBadge();renderNotifs();
      document.getElementById('notifPanel').classList.remove('show');
      openEdit(btn.dataset.id);
    });
  });
  c.querySelectorAll('.np-item').forEach(item=>{
    item.addEventListener('click',()=>{
      const n=notifications.find(x=>x.id===parseInt(item.dataset.id));
      if(n){n.read=true;updateBadge();renderNotifs();}
    });
  });
}
function renderNotifItem(n){
  const b=n.booking;
  const unread=n.read?'':'unread';
  return`<div class="np-item ${unread}" data-id="${n.id}">
    <div class="np-guest">${b.full_name}</div>
    <div class="np-details">
      <span class="np-det-item"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${fmtDate(b.check_in_date)}</span>
      <span class="np-det-item"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>${b.room_type}</span>
      <span class="np-det-item"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>${fmtTime24(b.arrival_time)}</span>
      <span class="np-det-item"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Rs ${b.total_amount}</span>
    </div>
    <div class="np-time">${timeAgo(n.timestamp)}</div>
    <div class="np-btns">
      <button class="np-btn done" data-id="${n.id}"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>Done</button>
      <button class="np-btn view" data-id="${n.id}"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>View</button>
    </div>
  </div>`;
}

/* ─── SESSION CHECK ─── */
(async()=>{
  const{data:{session}}=await sb.auth.getSession();
  if(session){
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('app').classList.add('visible');
    await init();
  }
})();

})();// end IIFE
</script>
</body>
</html>
