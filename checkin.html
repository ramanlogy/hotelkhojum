<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Divine Guest House – Check-in</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #faf9f7;
    --surface: #ffffff;
    --border: #e8e5e0;
    --border-focus: #1a1a1a;
    --text-primary: #1a1a1a;
    --text-secondary: #7a756e;
    --text-muted: #a89f95;
    --accent: #1a1a1a;
    --accent-light: #f0efed;
    --green: #22a667;
    --green-bg: #edfbf3;
    --red: #d44a3a;
    --red-bg: #fef2f0;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
    --radius: 14px;
    --radius-sm: 10px;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  body {
    font-family: 'DM Sans', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text-primary);
    font-size: 15px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }

  .app {
    max-width: 440px;
    margin: 0 auto;
    min-height: 100vh;
    background: var(--surface);
    position: relative;
  }

  /* ─── HEADER ─── */
  .header {
    padding: 28px 24px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    position: sticky; top: 0; z-index: 50;
  }
  .header-top {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 4px;
  }
  .brand {
    font-family: 'Playfair Display', serif;
    font-size: 20px; font-weight: 600;
    letter-spacing: -0.3px;
  }
  .brand span { color: var(--text-secondary); font-weight: 500; }
  .header-badge {
    font-size: 11px; font-weight: 500;
    color: var(--green);
    background: var(--green-bg);
    padding: 4px 10px; border-radius: 20px;
    letter-spacing: 0.3px;
  }
  .header-sub {
    font-size: 13px; color: var(--text-muted);
    margin-top: 2px;
  }

  /* ─── CONTENT ─── */
  .content {
    padding: 28px 24px 110px;
  }

  /* ─── AUTO STRIP (date / room / time) ─── */
  .auto-strip {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
    margin-bottom: 28px;
  }
  .auto-chip {
    background: var(--accent-light);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 8px;
    text-align: center;
    cursor: pointer;
    transition: border-color .18s, box-shadow .18s;
    position: relative;
  }
  .auto-chip:focus-within {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(26,26,26,0.08);
  }
  .auto-chip-label {
    display: flex; align-items: center; justify-content: center; gap: 4px;
    font-size: 10px; font-weight: 600; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.6px;
    margin-bottom: 5px;
  }
  .auto-chip-label svg { width: 11px; height: 11px; color: var(--text-muted); }
  .auto-chip-value {
    font-size: 13px; font-weight: 600; color: var(--text-primary);
  }
  .auto-chip-value input {
    background: transparent; border: none; outline: none;
    font-family: inherit; font-size: 13px; font-weight: 600;
    color: var(--text-primary); text-align: center; width: 100%;
    cursor: pointer;
  }
  .auto-chip-value input[type="date"]::-webkit-calendar-picker-indicator {
    display: none;
  }
  .auto-chip-badge {
    position: absolute; top: -6px; right: -3px;
    font-size: 9px; font-weight: 600; color: var(--green);
    background: var(--green-bg); border: 1px solid #c6f0dc;
    padding: 1px 5px; border-radius: 8px; letter-spacing: 0.2px;
  }
  .auto-chip-badge.manual {
    color: #9b7c2e;
    background: #fef9ec;
    border-color: #f5e6b8;
  }

  /* ─── DIVIDER ─── */
  .divider { height: 1px; background: var(--border); margin: 0 0 24px; }

  /* ─── FIELD ─── */
  .field { margin-bottom: 18px; }
  .field-label {
    display: flex; align-items: center; gap: 6px;
    font-size: 12px; font-weight: 600; color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 0.6px;
    margin-bottom: 8px;
  }
  .field-label svg { width: 14px; height: 14px; }
  .field-label .req { color: var(--red); font-size: 14px; line-height: 1; }

  .input-wrap { position: relative; }
  .input-wrap input {
    width: 100%; padding: 13px 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: inherit; font-size: 15px;
    color: var(--text-primary);
    background: var(--surface);
    transition: border-color .18s, box-shadow .18s;
  }
  .input-wrap input::placeholder { color: var(--text-muted); }
  .input-wrap input:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(26,26,26,0.08);
  }
  .input-wrap input[type="tel"] { letter-spacing: 0.8px; }

  /* ─── STAY TYPE ROW ─── */
  .stay-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 18px;
  }
  .stay-btn {
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 11px 6px;
    text-align: center; cursor: pointer;
    background: var(--surface);
    transition: all .18s;
  }
  .stay-btn:active { transform: scale(0.96); }
  .stay-btn.active {
    border-color: var(--accent);
    background: var(--accent);
    color: #fff;
  }
  .stay-btn-name { font-size: 13px; font-weight: 600; }
  .stay-btn-time { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
  .stay-btn.active .stay-btn-time { color: rgba(255,255,255,0.6); }

  /* ─── ROOM SELECTOR ─── */
  .room-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 18px;
  }
  .room-btn {
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 10px;
    cursor: pointer;
    background: var(--surface);
    transition: all .18s;
    position: relative;
  }
  .room-btn:active { transform: scale(0.97); }
  .room-btn.active {
    border-color: var(--accent);
    background: var(--accent);
    color: #fff;
  }
  .room-btn.disabled {
    opacity: 0.35; pointer-events: none;
  }
  .room-btn-header { display: flex; align-items: center; justify-content: space-between; }
  .room-btn-name { font-size: 13px; font-weight: 600; }
  .room-btn-avail {
    font-size: 10px; font-weight: 600;
    color: var(--green); background: var(--green-bg);
    padding: 2px 7px; border-radius: 8px;
  }
  .room-btn.active .room-btn-avail {
    color: var(--green); background: rgba(255,255,255,0.18);
  }
  .room-btn.disabled .room-btn-avail {
    color: var(--red); background: var(--red-bg);
  }
  .room-btn-number {
    font-size: 11px; color: var(--text-muted); margin-top: 4px;
  }
  .room-btn.active .room-btn-number { color: rgba(255,255,255,0.55); }

  /* ─── ROOM NUMBER PICKER ─── */
  .room-numbers-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    margin-top: 10px;
    padding: 10px;
    background: var(--bg);
    border-radius: var(--radius-sm);
  }
  .room-num-btn {
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 10px 6px;
    text-align: center;
    cursor: pointer;
    background: var(--surface);
    font-size: 13px;
    font-weight: 600;
    transition: all .15s;
  }
  .room-num-btn:active { transform: scale(0.94); }
  .room-num-btn.selected {
    border-color: var(--accent);
    background: var(--accent);
    color: #fff;
  }
  .room-num-btn.occupied {
    opacity: 0.3;
    pointer-events: none;
    background: var(--red-bg);
    border-color: #f5ccc7;
  }

  /* ─── PAYMENT ─── */
  .pay-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
  .pay-box {
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
    background: var(--surface);
  }
  .pay-box-label {
    display: flex; align-items: center; gap: 6px;
    font-size: 11px; font-weight: 600; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .pay-box-label svg { width: 14px; height: 14px; }
  .pay-box input {
    width: 100%; border: none; outline: none;
    font-family: inherit; font-size: 20px; font-weight: 600;
    color: var(--text-primary); background: transparent;
  }
  .pay-box input::placeholder { color: var(--border); }
  .pay-total {
    background: var(--accent-light);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 14px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .pay-total-label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
  .pay-total-value { font-size: 22px; font-weight: 700; color: var(--text-primary); }

  /* ─── DOC UPLOAD ─── */
  .upload-zone {
    border: 1.8px dashed var(--border);
    border-radius: var(--radius);
    padding: 24px 16px;
    text-align: center;
    cursor: pointer;
    transition: all .2s;
    background: var(--bg);
    position: relative;
  }
  .upload-zone:hover { border-color: var(--text-secondary); background: var(--surface); }
  .upload-zone.has-file {
    border-style: solid; border-color: var(--green);
    background: var(--green-bg); padding: 14px;
  }
  .upload-icon {
    width: 40px; height: 40px;
    margin: 0 auto 10px;
    background: var(--surface); border-radius: 10px;
    box-shadow: var(--shadow-sm);
    display: flex; align-items: center; justify-content: center;
  }
  .upload-icon svg { width: 20px; height: 20px; color: var(--text-secondary); }
  .upload-text { font-size: 13px; font-weight: 500; color: var(--text-primary); }
  .upload-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
  .upload-zone input[type="file"] { display: none; }

  .upload-preview {
    display: none; width: 100%; height: 100%;
    border-radius: 8px; object-fit: cover;
  }
  .upload-preview.show { display: block; }

  .upload-change {
    display: none; position: absolute; bottom: 10px; right: 12px;
    font-size: 11px; font-weight: 600; color: var(--green);
    background: #fff; border: 1px solid #c6f0dc;
    padding: 3px 10px; border-radius: 8px;
  }
  .upload-zone.has-file .upload-change { display: block; }

  /* ─── ERROR ─── */
  .error-bar {
    display: none;
    background: var(--red-bg); border: 1px solid #f5ccc7;
    border-radius: var(--radius-sm); padding: 10px 14px;
    font-size: 13px; color: var(--red); font-weight: 500;
    margin-bottom: 10px;
  }
  .error-bar.show { display: flex; align-items: center; gap: 8px; }
  .error-bar svg { width: 16px; height: 16px; flex-shrink: 0; }

  /* ─── BOTTOM ACTION ─── */
  .action-bar {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding: 12px 24px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
    z-index: 50;
  }
  .action-inner { max-width: 440px; margin: 0 auto; }

  .btn-submit {
    width: 100%; padding: 15px;
    background: var(--accent); color: #fff;
    border: none; border-radius: var(--radius-sm);
    font-family: inherit; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: opacity .18s, transform .1s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    letter-spacing: 0.2px;
  }
  .btn-submit:active { transform: scale(0.97); }
  .btn-submit:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .btn-submit svg { width: 18px; height: 18px; }

  .spinner {
    width: 18px; height: 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin .5s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ─── SUCCESS ─── */
  .success-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 200;
    background: var(--surface);
    overflow-y: auto;
    animation: fadeUp .3s cubic-bezier(.22,.61,.36,1);
  }
  .success-overlay.show { display: block; }
  @keyframes fadeUp { from { transform: translateY(40px); opacity:0; } to { transform:translateY(0); opacity:1; } }

  .success-inner {
    max-width: 440px; margin: 0 auto;
    padding: 60px 24px 40px;
    text-align: center;
  }
  .success-check {
    width: 72px; height: 72px; margin: 0 auto 20px;
    background: var(--green); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 16px rgba(34,166,103,0.3);
  }
  .success-check svg { width: 36px; height: 36px; color: #fff; }
  .success-title { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; margin-bottom: 4px; }
  .success-sub { font-size: 13px; color: var(--text-muted); margin-bottom: 28px; }

  .success-room-badge {
    display: inline-flex; align-items: center; gap: 8px;
    background: var(--accent-light); border: 1px solid var(--border);
    border-radius: 12px; padding: 8px 18px;
    margin-bottom: 24px;
  }
  .success-room-label { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.6px; }
  .success-room-num { font-size: 28px; font-weight: 700; color: var(--text-primary); }

  .success-card {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 18px;
    text-align: left; margin-bottom: 24px;
  }
  .success-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 9px 0; border-bottom: 1px solid var(--border);
    font-size: 14px;
  }
  .success-row:last-child { border-bottom: none; }
  .success-row-label { color: var(--text-muted); }
  .success-row-value { font-weight: 600; color: var(--text-primary); }

  .btn-new {
    width: 100%; padding: 14px;
    background: var(--accent); color: #fff;
    border: none; border-radius: var(--radius-sm);
    font-family: inherit; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: opacity .18s;
  }
  .btn-new:active { opacity: 0.8; }

  /* ─── SECTION LABEL ─── */
  .section-label {
    font-size: 11px; font-weight: 600; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.7px;
    margin-bottom: 10px; margin-top: 4px;
    display: flex; align-items: center; gap: 6px;
  }
  .section-label svg { width: 13px; height: 13px; }
</style>
</head>
<body>

<div class="app" id="app">

  <!-- HEADER -->
  <div class="header">
    <div class="header-top">
      <div class="brand">Divine <span>Guest House</span></div>
      <div class="header-badge">Reception</div>
    </div>
    <div class="header-sub">New guest check-in</div>
  </div>

  <!-- CONTENT -->
  <div class="content" id="formContent">
     <!-- STAY TYPE -->
    <div class="section-label">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>
      Stay Type
    </div>
    <div class="stay-row" id="stayRow">
      <div class="stay-btn active" data-type="Daycation" onclick="selectStay(this)">
        <div class="stay-btn-name">Day</div>
        <div class="stay-btn-time">12 PM – 5 PM</div>
      </div>
      <div class="stay-btn" data-type="Staycation" onclick="selectStay(this)">
        <div class="stay-btn-name">Night</div>
        <div class="stay-btn-time">6 PM – 11 AM</div>
      </div>
      <div class="stay-btn " data-type="Full Stay" onclick="selectStay(this)">
        <div class="stay-btn-name">Full Day</div>
        <div class="stay-btn-time">12 PM – 11 AM</div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- AUTO STRIP: Date / Room / Time -->
    <div class="auto-strip">
      <div class="auto-chip" onclick="document.getElementById('datePicker').click()">
        <div class="auto-chip-label">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Date
        </div>
        <div class="auto-chip-value" id="chipDateDisp">—</div>
        <input type="date" id="datePicker" style="position:absolute;inset:0;opacity:0;width:100%;height:100%;cursor:pointer;" />
        <div class="auto-chip-badge manual" id="dateBadge">Manual</div>
      </div>

      <div class="auto-chip" id="chipRoom" onclick="openRoomModal()">
        <div class="auto-chip-label">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
          Room
        </div>
        <div class="auto-chip-value" id="chipRoomDisp">—</div>
        <div class="auto-chip-badge manual" id="roomBadge">Manual</div>
      </div>

      <div class="auto-chip" onclick="document.getElementById('timePicker').click()">
        <div class="auto-chip-label">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>
          Time
        </div>
        <div class="auto-chip-value" id="chipTimeDisp">—</div>
        <input type="time" id="timePicker" style="position:absolute;inset:0;opacity:0;width:100%;height:100%;cursor:pointer;" />
        <div class="auto-chip-badge manual" id="timeBadge">Manual</div>
      </div>
    </div>

    <div class="divider"></div>
    

    <!-- GUEST NAME -->
    <div class="field">
      <label class="field-label">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="8" r="4"/></svg>
        Guest Name <span class="req">*</span>
      </label>
      <div class="input-wrap">
        <input type="text" id="guestName" placeholder="Full name" autocomplete="off" spellcheck="false">
      </div>
    </div>

    <!-- PHONE -->
    <div class="field">
      <label class="field-label">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>
        Phone Number
      </label>
      <div class="input-wrap">
        <input type="tel" id="guestPhone" placeholder="10-digit number (optional)" maxlength="10" inputmode="numeric">
      </div>
    </div>

    <div class="divider"></div>

   

    <!-- PAYMENT -->
    <div class="section-label">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
      Payment
    </div>
    <div class="pay-row">
      <div class="pay-box">
        <div class="pay-box-label">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
          Online
        </div>
        <input type="number" id="payOnline" placeholder="0" min="0" oninput="updateTotal()">
      </div>
      <div class="pay-box">
        <div class="pay-box-label">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
          Cash
        </div>
        <input type="number" id="payCash" placeholder="0" min="0" oninput="updateTotal()">
      </div>
    </div>
    <div class="pay-total">
      <span class="pay-total-label">Total</span>
      <span class="pay-total-value" id="payTotal">Rs 0</span>
    </div>

    <div class="divider" style="margin-top:18px;"></div>

    <!-- ID / DOC UPLOAD -->
    <div class="section-label">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>
      ID / Document <span class="req" style="color:var(--red);font-size:14px;">*</span>
    </div>
    <label class="upload-zone" id="uploadZone" for="docInput">
      <div id="uploadPlaceholder">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </div>
        <div class="upload-text">Tap to upload or take photo</div>
        <div class="upload-sub">Citizenship, PAN, Passport, Driving Licence</div>
      </div>
      <img id="docPreview" class="upload-preview" alt="ID document">
      <span class="upload-change">Change</span>
      <input type="file" id="docInput" accept="image/*" capture="environment" onchange="handleDocUpload(event)">
    </label>

  </div>

  <!-- BOTTOM ACTION -->
  <div class="action-bar">
    <div class="action-inner">
      <div class="error-bar" id="errorBar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="errorText"></span>
      </div>
      <button class="btn-submit" id="btnSubmit" onclick="handleCheckin()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22,4 12,14.01 9,11.01"/></svg>
        <span id="btnText">Complete Check-in</span>
      </button>
    </div>
  </div>

</div><!-- /app -->

<!-- SUCCESS OVERLAY -->
<div class="success-overlay" id="successOverlay">
  <div class="success-inner">
    <div class="success-check">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20,6 9,17 4,12"/></svg>
    </div>
    <h2 class="success-title">Check-in Complete</h2>
    <p class="success-sub">Guest has been checked in successfully</p>
    <div class="success-room-badge">
      <span class="success-room-label">Room</span>
      <span class="success-room-num" id="succRoom">—</span>
    </div>
    <div class="success-card" id="succCard"></div>
    <button class="btn-new" onclick="location.reload()">New Check-in</button>
  </div>
</div>

<!-- ─── SCRIPT ─── -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ── CONFIG ──
const SUPABASE_URL = 'https://fzwnglhxtmtltpysdzma.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6d25nbGh4dG10bHRweXNkem1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODE0MzAsImV4cCI6MjA4NDE1NzQzMH0.PuES2nphqkKU-FqzBge6LlptVibSfeTQcUExEdfTleg';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const ROOM_MAP = {
  'Cozy Mini':         ['102','201','202','301','302'],
  'Compact Twin':      ['203','303'],
  'Convenient Queen':  ['101']
};
const ROOM_TYPES = Object.keys(ROOM_MAP);
const ALL_ROOMS = Object.values(ROOM_MAP).flat();

// ── STATE ──
let state = {
  date:        new Date().toISOString().split('T')[0],
  time:        nowHHMM(),
  stayType:    'Full Stay',
  roomType:    null,
  roomNumber:  null,
  docFile:     null,
  availability: {},
  occupiedRooms: []
};

// ── INIT ──
(function init() {
  updateChipDate();
  updateChipTime();
  document.getElementById('datePicker').value = state.date;
  document.getElementById('datePicker').min   = state.date;
  document.getElementById('timePicker').value = state.time;

  document.getElementById('datePicker').onchange = e => {
    state.date = e.target.value;
    updateChipDate();
    loadAvail();
  };
  document.getElementById('timePicker').onchange = e => {
    state.time = e.target.value;
    updateChipTime();
  };

  loadAvail();
})();

// ── HELPERS ──
function nowHHMM() {
  const n = new Date();
  return String(n.getHours()).padStart(2,'0') + ':' + String(n.getMinutes()).padStart(2,'0');
}

function fmtDate(iso) {
  const d = new Date(iso + 'T00:00:00');
  return d.toLocaleDateString('en-IN', { day:'numeric', month:'short' });
}

function fmtTime(hhmm) {
  const [h,m] = hhmm.split(':').map(Number);
  const ap = h >= 12 ? 'PM' : 'AM';
  return (h % 12 || 12) + ':' + String(m).padStart(2,'0') + ' ' + ap;
}

function updateChipDate() {
  document.getElementById('chipDateDisp').textContent = fmtDate(state.date);
}
function updateChipTime() {
  document.getElementById('chipTimeDisp').textContent = fmtTime(state.time);
}

// ── STAY SELECT ──
function selectStay(el) {
  document.querySelectorAll('.stay-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  state.stayType = el.dataset.type;
  state.roomType  = null;
  state.roomNumber = null;
  document.getElementById('chipRoomDisp').textContent = '—';
  loadAvail();
}

// ── LOAD AVAILABILITY ──
async function loadAvail() {
  try {
    // Get all active bookings for selected date and stay type
    const { data } = await db
      .from('bookings')
      .select('room_number')
      .eq('check_in_date', state.date)
      .eq('stay_type', state.stayType)
      .neq('status', 'checked_out'); // Exclude checked out rooms

    const occupied = (data || []).map(b => b.room_number);
    state.occupiedRooms = occupied;
    
    const avail = {};
    ROOM_TYPES.forEach(t => {
      avail[t] = (ROOM_MAP[t] || []).filter(r => !occupied.includes(r));
    });
    state.availability = avail;

    // Auto-assign first available room
    autoAssignRoom();
  } catch (e) {
    console.error(e);
  }
}

function autoAssignRoom() {
  // Pick first type that has rooms available
  for (const t of ROOM_TYPES) {
    if (state.availability[t] && state.availability[t].length > 0) {
      state.roomType   = t;
      state.roomNumber = state.availability[t][0];
      document.getElementById('chipRoomDisp').textContent = state.roomNumber;
      return;
    }
  }
  state.roomType   = null;
  state.roomNumber = null;
  document.getElementById('chipRoomDisp').textContent = 'None';
}

// ── ROOM MODAL ──
let roomPickerOpen = false;
function openRoomModal() {
  if (roomPickerOpen) { closeRoomPicker(); return; }
  roomPickerOpen = true;

  const strip = document.querySelector('.auto-strip');
  let picker = document.getElementById('roomPicker');
  if (!picker) {
    picker = document.createElement('div');
    picker.id = 'roomPicker';
    picker.style.cssText = 'margin-bottom:18px;';
    strip.after(picker);
  }

  let html = '<div class="room-row">';
  ROOM_TYPES.forEach(t => {
    const av = state.availability[t] || [];
    const isActive = state.roomType === t;
    const isDis = av.length === 0;
    html += `<div class="room-btn ${isActive?'active':''} ${isDis?'disabled':''}" onclick="pickRoomType('${t}')">
      <div class="room-btn-header">
        <span class="room-btn-name">${t}</span>
        <span class="room-btn-avail">${isDis ? 'Full' : av.length + ' left'}</span>
      </div>
      <div class="room-btn-number">${state.roomType === t && state.roomNumber ? '→ ' + state.roomNumber : (isDis ? '—' : 'Tap to select')}</div>
    </div>`;
  });
  html += '</div>';
  
  // Add room number grid
  html += '<div class="room-numbers-grid" id="roomNumberGrid">';
  html += '</div>';
  
  picker.innerHTML = html;
  picker.style.display = 'block';
  
  // Show room numbers if a type is selected
  if (state.roomType) {
    showRoomNumbers(state.roomType);
  }
}

function pickRoomType(type) {
  const av = state.availability[type];
  if (!av || av.length === 0) return;
  
  state.roomType = type;
  showRoomNumbers(type);
  
  // Update the room type buttons
  document.querySelectorAll('.room-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
}

function showRoomNumbers(roomType) {
  const grid = document.getElementById('roomNumberGrid');
  if (!grid) return;
  
  const allRoomsForType = ROOM_MAP[roomType] || [];
  
  let html = '';
  allRoomsForType.forEach(roomNum => {
    const isOccupied = state.occupiedRooms.includes(roomNum);
    const isSelected = state.roomNumber === roomNum;
    
    html += `<div class="room-num-btn ${isSelected?'selected':''} ${isOccupied?'occupied':''}" 
                  onclick="selectRoomNumber('${roomNum}', ${isOccupied})">
              ${roomNum}
            </div>`;
  });
  
  grid.innerHTML = html;
}

function selectRoomNumber(roomNum, isOccupied) {
  if (isOccupied) return;
  
  state.roomNumber = roomNum;
  document.getElementById('chipRoomDisp').textContent = roomNum;
  
  // Update selected state
  document.querySelectorAll('.room-num-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
  event.currentTarget.classList.add('selected');
  
  // Close picker after selection
  setTimeout(() => closeRoomPicker(), 300);
}

function closeRoomPicker() {
  roomPickerOpen = false;
  const p = document.getElementById('roomPicker');
  if (p) p.style.display = 'none';
}

// ── PAYMENT ──
function updateTotal() {
  const o = parseInt(document.getElementById('payOnline').value) || 0;
  const c = parseInt(document.getElementById('payCash').value)   || 0;
  document.getElementById('payTotal').textContent = 'Rs ' + (o + c);
}

// ── DOC UPLOAD ──
function handleDocUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  state.docFile = file;
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById('uploadPlaceholder').style.display = 'none';
    const img = document.getElementById('docPreview');
    img.src = ev.target.result;
    img.classList.add('show');
    document.getElementById('uploadZone').classList.add('has-file');
  };
  reader.readAsDataURL(file);
}

// ── ERROR ──
function showError(msg) {
  document.getElementById('errorText').textContent = msg;
  document.getElementById('errorBar').classList.add('show');
  setTimeout(() => document.getElementById('errorBar').classList.remove('show'), 3200);
}

// ── CHECK-IN ──
async function handleCheckin() {
  const name  = document.getElementById('guestName').value.trim();
  const phone = document.getElementById('guestPhone').value.trim();
  const online = parseInt(document.getElementById('payOnline').value) || 0;
  const cash   = parseInt(document.getElementById('payCash').value)   || 0;
  const total  = online + cash;

  if (!name)                       return showError('Enter guest name');
  if (phone && phone.length < 10)  return showError('Phone number must be 10 digits if provided');
  if (!state.roomNumber)           return showError('No room available — change stay type or date');
  if (total === 0)                 return showError('Enter payment amount');
  if (!state.docFile)              return showError('Upload an ID document');

  // Check if room is still available (prevent double booking)
  const { data: existingBooking } = await db
    .from('bookings')
    .select('id')
    .eq('check_in_date', state.date)
    .eq('stay_type', state.stayType)
    .eq('room_number', state.roomNumber)
    .neq('status', 'checked_out')
    .maybeSingle();

  if (existingBooking) {
    await loadAvail(); // Refresh availability
    return showError('Room ' + state.roomNumber + ' is no longer available. Please select another room.');
  }

  // loading
  const btn = document.getElementById('btnSubmit');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div><span>Processing…</span>';

  try {
    // upload doc
    let docUrl = null;
    if (state.docFile) {
      const ext  = state.docFile.name.split('.').pop();
      const path = `${Date.now()}_${Math.random().toString(36).slice(2,8)}.${ext}`;
      
      const { data: uploadData, error: ue } = await db.storage
        .from('guest_photos')
        .upload(path, state.docFile, {
          contentType: state.docFile.type,
          cacheControl: '3600',
          upsert: false
        });
        
      if (ue) {
        console.error('Upload error:', ue);
        throw new Error('Document upload failed: ' + ue.message);
      }
      
      if (uploadData) {
        const { data: urlData } = db.storage.from('guest_photos').getPublicUrl(path);
        docUrl = urlData.publicUrl;
      }
    }

    const booking = {
      full_name:        name,
      phone_number:     phone,
      check_in_date:    state.date,
      arrival_time:     state.time,
      stay_type:        state.stayType,
      room_type:        state.roomType,
      room_number:      state.roomNumber,
      total_amount:     total,
      base_amount:      total,
      discount_percent: 0,
      payment_online:   online,
      payment_cash:     cash,
      status:           'confirmed',
      payment_status:   'paid',
      guest_photo_url:  docUrl,
      qr_token:         'DGH-' + Math.random().toString(36).substr(2,6).toUpperCase()
    };

    const { data, error } = await db.from('bookings').insert([booking]).select();
    if (error) throw error;

    showSuccess(data[0]);
  } catch (err) {
    console.error(err);
    showError('Check-in failed — please try again');
    btn.disabled = false;
    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22,4 12,14.01 9,11.01"/></svg><span>Complete Check-in</span>`;
  }
}

// ── SUCCESS ──
function showSuccess(b) {
  document.getElementById('succRoom').textContent = b.room_number;
  document.getElementById('succCard').innerHTML = `
    <div class="success-row"><span class="success-row-label">Guest</span><span class="success-row-value">${b.full_name}</span></div>
    <div class="success-row"><span class="success-row-label">Phone</span><span class="success-row-value">${b.phone_number}</span></div>
    <div class="success-row"><span class="success-row-label">Date</span><span class="success-row-value">${fmtDate(b.check_in_date)}</span></div>
    <div class="success-row"><span class="success-row-label">Arrival</span><span class="success-row-value">${fmtTime(b.arrival_time)}</span></div>
    <div class="success-row"><span class="success-row-label">Stay</span><span class="success-row-value">${b.stay_type}</span></div>
    <div class="success-row"><span class="success-row-label">Room Type</span><span class="success-row-value">${b.room_type}</span></div>
    <div class="success-row"><span class="success-row-label">Paid</span><span class="success-row-value">Rs ${b.total_amount}</span></div>
    ${b.payment_online>0 ? `<div class="success-row"><span class="success-row-label">— Online</span><span class="success-row-value">Rs ${b.payment_online}</span></div>` : ''}
    ${b.payment_cash>0   ? `<div class="success-row"><span class="success-row-label">— Cash</span><span class="success-row-value">Rs ${b.payment_cash}</span></div>` : ''}
    <div class="success-row"><span class="success-row-label">Ref</span><span class="success-row-value">${b.qr_token}</span></div>
  `;
  document.getElementById('successOverlay').classList.add('show');
}
</script>
</body>
</html>
